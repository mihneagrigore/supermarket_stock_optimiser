name: Deploy to Render and Stream Logs

on:
  workflow_dispatch:   # can trigger manually
  push:
    branches:
      - main

jobs:
  deploy-and-fetch-logs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Trigger Render Deployment
        id: trigger
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          echo "Triggering deployment..."
          deploy_response=$(curl -s -X POST -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$SERVICE_ID/deploys" \
            -H "Content-Type: application/json")
          
          echo "$deploy_response" | jq

          # Capture DEPLOY_ID to output for next steps
          DEPLOY_ID=$(echo "$deploy_response" | jq -r '.id')
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "Deployment ID: $DEPLOY_ID"   # <-- prints deploy id in GitHub logs

      - name: Stream deployment logs
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          DEPLOY_ID=${{ steps.trigger.outputs.deploy_id }}
          echo "Streaming logs for deployment: $DEPLOY_ID"

          # Loop until deployment finishes
          while true; do
            logs=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID/logs")

            if [[ $logs == \[* ]]; then
              echo "$logs" | jq -r '.[] | .message'
            else
              echo "Logs not ready yet or returned error:"
              echo "$logs"
            fi

            # Check deployment state
            state=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID" | jq -r '.state')
            echo "Deployment state: $state"

            if [[ "$state" == "LIVE" || "$state" == "FAILED" ]]; then
              echo "Deployment finished with state: $state"
              break
            fi

            sleep 15  # wait 15 seconds before next poll
          done
