name: Deploy to Render after CodeQL check

on:
  push:
    branches:
      - main

permissions:
  contents: read
  actions: write

env:
  REPO: mihneagrigore/supermarket_stock_optimiser
  TOKEN_GITAPI: ${{ secrets.TOKEN_GITAPI }}

jobs:
  deploy-to-render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Wait for latest CodeQL check suite
        id: wait_codeql
        run: |
          echo "Polling GitHub API for ALL CodeQL check suites..."

          while true; do

            # 1. Fetch ALL CodeQL check suite IDs for this commit
            suite_ids=$(curl -s \
              -H "Authorization: token $TOKEN_GITAPI" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/commits/$GITHUB_SHA/check-suites" | \
              jq -r '.check_suites | map(select(.app.name=="CodeQL")) | .[].id')

            if [[ -z "$suite_ids" ]]; then
              echo "No CodeQL suites found yet. Waiting..."
              sleep 10
              continue
            fi

            echo "Found CodeQL suite IDs:"
            echo "$suite_ids"
            echo "--------------------------------"

            all_suites_success=true

            # 2. For each suite, fetch and check its check-runs
            for suite in $suite_ids; do
              echo "Checking suite: $suite"

              runs_json=$(curl -s \
                -H "Authorization: token $TOKEN_GITAPI" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/check-suites/$suite/check-runs")

              runs=$(echo "$runs_json" | jq -r '.check_runs[] | "\(.name) \(.status) \(.conclusion)"')

              echo "$runs"
              echo "--------------------------------"

              suite_success=true

              while IFS= read -r run; do
                name=$(echo "$run" | awk '{print $1" "$2}')  # job name
                status=$(echo "$run" | awk '{print $3}')     # "queued" / "in_progress" / "completed"
                conclusion=$(echo "$run" | awk '{print $4}') # "success" / "failure" / null

                if [[ "$status" != "completed" ]]; then
                  suite_success=false
                fi

                if [[ "$conclusion" == "failure" ]]; then
                  echo "❌ CodeQL FAILED in suite $suite"
                  exit 1
                fi

              done <<< "$runs"

              if ! $suite_success; then
                all_suites_success=false
              fi
            done

            if $all_suites_success; then
              echo "✅ All CodeQL check suites COMPLETED successfully!"
              break
            fi

            echo "CodeQL suites still running... waiting..."
            sleep 10
          done

      - name: Trigger Render Deployment
        id: trigger
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          echo "Triggering deployment..."
          deploy_response=$(curl -s -X POST -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$SERVICE_ID/deploys" \
            -H "Content-Type: application/json")
          
          echo "$deploy_response" | jq
          DEPLOY_ID=$(echo "$deploy_response" | jq -r '.id')
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "Deployment ID: $DEPLOY_ID"

      - name: Wait for Deployment Status
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          DEPLOY_ID=${{ steps.trigger.outputs.deploy_id }}
          echo "Polling deployment status for $DEPLOY_ID..."

          while true; do
            response=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID")
            
            status=$(echo "$response" | jq -r '.status')
            echo "Deployment status: $status"

            if [[ "$status" == "live" ]]; then
              echo "Deployment succeeded!"
              exit 0
            elif [[ "$status" == "build_failed" || "$status" == "failed" ]]; then
              echo "Deployment failed!"
              exit 1
            fi

            sleep 15
          done
