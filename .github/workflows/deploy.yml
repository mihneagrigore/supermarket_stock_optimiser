name: CodeQL + Render Deployment

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  deploy-to-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: codeql-analysis        # This ensures this job only runs after CodeQL
    if: ${{ success() }}          # Only run if CodeQL succeeded
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Trigger Render Deployment
        id: trigger
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          echo "Triggering deployment..."
          deploy_response=$(curl -s -X POST -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$SERVICE_ID/deploys" \
            -H "Content-Type: application/json")
          
          echo "$deploy_response" | jq

          DEPLOY_ID=$(echo "$deploy_response" | jq -r '.id')
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "Deployment ID: $DEPLOY_ID"

      - name: Wait for Deployment Status
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.SERVICE_ID }}
        run: |
          DEPLOY_ID=${{ steps.trigger.outputs.deploy_id }}
          echo "Polling deployment status for $DEPLOY_ID..."

          while true; do
            response=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID")
            
            status=$(echo "$response" | jq -r '.status')
            echo "Deployment status: $status"

            if [[ "$status" == "live" ]]; then
              echo "Deployment succeeded!"
              exit 0
            elif [[ "$status" == "build_failed" || "$status" == "failed" ]]; then
              echo "Deployment failed!"
              exit 1
            fi

            sleep 15
          done
